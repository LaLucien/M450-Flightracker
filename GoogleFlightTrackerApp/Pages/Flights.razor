@page "/flights"
@using FlightTracker.Contracts
@using MudBlazor
@using System.Globalization
@inject FlightTracker.Web.Services.FlightService FlightService
@inject FlightTracker.Web.Services.UiRefreshService UiRefreshService
@inject NavigationManager NavigationManager

<MudText Typo="Typo.h5" GutterBottom="true">Flugsuche</MudText>

@* Filter panel is optional now *@
@if (ShowFilter)
{
 <MudCard Class="mb-4">
 <MudCardContent>
 <MudStack Row="true" Spacing="2">
 <MudTextField @bind-Value="_origin" Label="Origin (IATA)" />
 <MudTextField @bind-Value="_destination" Label="Destination (IATA)" />
 <MudDatePicker @bind-Date="_departureDate" Label="Departure" DateFormat="yyyy-MM-dd" />
 <MudTextField @bind-Value="_flightNumber" Label="Flight number (optional)" />
 <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SearchAsync" Disabled="@_loading">
 @if (_loading)
 {
 <MudProgressCircular Size="Size.Small" Indeterminate="true" />
 }
 else
 {
 <span>Suchen</span>
 }
 </MudButton>
 </MudStack>
 </MudCardContent>
 </MudCard>
}

@if (_flights == null && _loading)
{
 <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
}
else
{
 <MudTable Items="@_flights" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading">
 <HeaderContent>
 <MudTh>ID</MudTh>
 <MudTh>Flight</MudTh>
 <MudTh>Abflugort</MudTh>
 <MudTh>Zielort</MudTh>
 <MudTh>Datum</MudTh>
 <MudTh></MudTh>
 </HeaderContent>
 <RowTemplate>
 <MudTd DataLabel="ID">@context.Id</MudTd>
 <MudTd DataLabel="Flight">@context.FlightNumber</MudTd>
 <MudTd DataLabel="Abflugort">@context.OriginIata</MudTd>
 <MudTd DataLabel="Zielort">@context.DestinationIata</MudTd>
 <MudTd DataLabel="Datum">@context.DepartureDate</MudTd>
 <MudTd>
 <MudButton Variant="Variant.Text" OnClick="() => SelectFlight(context)">Details</MudButton>
 </MudTd>
 </RowTemplate>
 <NoRecordsContent>
 <MudText Typo="Typo.subtitle2" Align="Align.Center">Keine Flüge vorhanden</MudText>
 </NoRecordsContent>
 </MudTable>
}

@code {
 [Parameter]
 public bool ShowFilter { get; set; } = true;

 private List<FlightResponseDto>? _flights;
 private bool _loading = false;

 private string _origin = "ZRH";
 private string _destination = "LHR";
 private DateTime? _departureDate = DateTime.Today.AddDays(7);
 private string? _flightNumber;

 [Parameter]
 public EventCallback<FlightResponseDto> OnSelected { get; set; }

 protected override async Task OnInitializedAsync()
 {
 UiRefreshService.RefreshRequested += HandleRefreshRequested;

 // parse query params and trigger search if provided
 var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
 var query = ParseQuery(uri.Query);
 if (query.TryGetValue("origin", out var qOrigin)) _origin = qOrigin;
 if (query.TryGetValue("destination", out var qDest)) _destination = qDest;
 if (query.TryGetValue("departure_date", out var qDep))
 {
 if (DateTime.TryParseExact(qDep, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var parsed))
 {
 _departureDate = parsed;
 }
 }

 // automatically search if any of the query params were present, or if filter is hidden (embedded)
 if (query.ContainsKey("origin") || query.ContainsKey("destination") || query.ContainsKey("departure_date") || !ShowFilter)
 {
 await SearchAsync();
 }
 }

 public void Dispose()
 {
 UiRefreshService.RefreshRequested -= HandleRefreshRequested;
 }

 private async Task HandleRefreshRequested()
 {
 await SearchAsync();
 }

 private async Task SearchAsync()
 {
 _loading = true;
 try
 {
 string? dep = _departureDate?.ToString("yyyy-MM-dd");
 _flights = await FlightService.GetFlightsAsync(
 origin: _origin,
 destination: _destination,
 departureDate: dep,
 flightNumber: string.IsNullOrWhiteSpace(_flightNumber) ? null : _flightNumber);
 }
 finally
 {
 _loading = false;
 }
 }

 private async Task SelectFlight(FlightResponseDto dto)
 {
 if (OnSelected.HasDelegate)
 await OnSelected.InvokeAsync(dto);
 else
 {
 // fallback navigation to details page
 NavigationManager.NavigateTo($"/flights/{dto.Id}");
 }
 }

 private static Dictionary<string, string> ParseQuery(string query)
 {
 var dict = new Dictionary<string, string>();
 if (string.IsNullOrEmpty(query)) return dict;
 var q = query.TrimStart('?');
 foreach (var part in q.Split('&', StringSplitOptions.RemoveEmptyEntries))
 {
 var idx = part.IndexOf('=');
 if (idx >=0)
 {
 var key = Uri.UnescapeDataString(part.Substring(0, idx));
 var val = Uri.UnescapeDataString(part.Substring(idx +1));
 dict[key] = val;
 }
 else
 {
 var key = Uri.UnescapeDataString(part);
 dict[key] = string.Empty;
 }
 }
 return dict;
 }
}
