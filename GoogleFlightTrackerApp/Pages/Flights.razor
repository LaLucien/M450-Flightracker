@page "/flights"
@using FlightTracker.Contracts
@using MudBlazor
@using System.Globalization
@inject FlightTracker.Web.Services.FlightService FlightService
@inject FlightTracker.Web.Services.UiRefreshService UiRefreshService
@inject NavigationManager NavigationManager

<MudText Typo="Typo.h5" GutterBottom="true">Flugsuche</MudText>

<MudTabs>
    <MudTab Label="Flights">
        <MudExpansionPanels Class="mb-4">
            <MudExpansionPanel Text="Results" Expanded="true">

                @if (ShowFilter)
                {
                    <MudCard Class="mb-0">
                        <MudCardContent>
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudTextField Value="@(_origin ?? string.Empty)" Label="Origin (IATA)" Disabled="true" />
                                <MudTextField Value="@(_destination ?? string.Empty)" Label="Destination (IATA)" Disabled="true" />
                                <MudDatePicker @bind-Date="_departureDate" Label="Departure" DateFormat="yyyy-MM-dd" />
                                <MudTextField @bind-Value="_flightNumber" Label="Flight number (optional)" />
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SearchAsync" Disabled="@_loading">
                                    @if (_loading)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                    }
                                    else
                                    {
                                        <span>Suchen</span>
                                    }
                                </MudButton>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }
                @if (_flights == null && _loading)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
                }
                else
                {
                    <MudTable Items="@_flights" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading">
                        <HeaderContent>
                            <MudTh>ID</MudTh>
                            <MudTh>Flight</MudTh>
                            <MudTh>Abflugort</MudTh>
                            <MudTh>Zielort</MudTh>
                            <MudTh>Datum</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="ID">@context.Id</MudTd>
                            <MudTd DataLabel="Flight">@context.FlightNumber</MudTd>
                            <MudTd DataLabel="Abflugort">@context.OriginIata</MudTd>
                            <MudTd DataLabel="Zielort">@context.DestinationIata</MudTd>
                            <MudTd DataLabel="Datum">@context.DepartureDate</MudTd>
                            <MudTd>
                                <MudButton Variant="Variant.Text" OnClick="() => SelectFlight(context)">Details</MudButton>
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Typo="Typo.subtitle2" Align="Align.Center">Keine Flüge vorhanden</MudText>
                        </NoRecordsContent>
                    </MudTable>
                }
            </MudExpansionPanel>
        </MudExpansionPanels>
    </MudTab>

    <MudTab Label="Flex stats">

        <MudExpansionPanels Class="mb-4">
            <MudExpansionPanel Text="Flex stats" Expanded="true">
                <FlexStats Origin="@_origin" Destination="@_destination" TargetDate='@(_departureDate?.ToString("yyyy-MM-dd"))' FlexDays="3" />
            </MudExpansionPanel>
        </MudExpansionPanels>
    </MudTab>
</MudTabs>

@code {
    [Parameter]
    public bool ShowFilter { get; set; } = true;

    private List<FlightResponseDto>? _flights;
    private bool _loading = false;

    private string? _origin = null;
    private string? _destination = null;
    private DateTime? _departureDate = DateTime.Today.AddDays(7);
    private string? _flightNumber;

    [Parameter]
    public EventCallback<FlightResponseDto> OnSelected { get; set; }

    protected override async Task OnInitializedAsync()
    {
        UiRefreshService.RefreshRequested += HandleRefreshRequested;

        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = ParseQuery(uri.Query);
        if (query.TryGetValue("origin", out var qOrigin)) _origin = qOrigin;
        if (query.TryGetValue("destination", out var qDest)) _destination = qDest;
        if (query.TryGetValue("departure_date", out var qDep))
        {
            if (DateTime.TryParseExact(qDep, "yyyy-MM-dd", CultureInfo.InvariantCulture, DateTimeStyles.None, out var parsed))
            {
                _departureDate = parsed;
            }
        }

        if (query.ContainsKey("origin") || query.ContainsKey("destination") || query.ContainsKey("departure_date") || !ShowFilter)
        {
            await SearchAsync();
        }
    }

    public void Dispose()
    {
        UiRefreshService.RefreshRequested -= HandleRefreshRequested;
    }

    private async Task HandleRefreshRequested()
    {
        await SearchAsync();
    }

    private async Task SearchAsync()
    {
        _loading = true;
        try
        {
            string? dep = _departureDate?.ToString("yyyy-MM-dd");
            _flights = await FlightService.GetFlightsAsync(
            origin: string.IsNullOrWhiteSpace(_origin) ? null : _origin,
            destination: string.IsNullOrWhiteSpace(_destination) ? null : _destination,
            departureDate: dep,
            flightNumber: string.IsNullOrWhiteSpace(_flightNumber) ? null : _flightNumber);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SelectFlight(FlightResponseDto dto)
    {
        if (OnSelected.HasDelegate)
            await OnSelected.InvokeAsync(dto);
        else
        {
            NavigationManager.NavigateTo($"/flights/{dto.Id}");
        }
    }

    private static Dictionary<string, string> ParseQuery(string query)
    {
        var dict = new Dictionary<string, string>();
        if (string.IsNullOrEmpty(query)) return dict;
        var q = query.TrimStart('?');
        foreach (var part in q.Split('&', StringSplitOptions.RemoveEmptyEntries))
        {
            var idx = part.IndexOf('=');
            if (idx >= 0)
            {
                var key = Uri.UnescapeDataString(part.Substring(0, idx));
                var val = Uri.UnescapeDataString(part.Substring(idx + 1));
                dict[key] = val;
            }
            else
            {
                var key = Uri.UnescapeDataString(part);
                dict[key] = string.Empty;
            }
        }
        return dict;
    }
}
